<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>iOS应用 main 执行前发生的事情 - 千行的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="千行的博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="千行的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这篇是对 iOS 应用启动时，main 函数执行前发生的事的一点总结，限于水平，如有错误请指正~ FAT 二进制FAT 二进制文件，将多种架构的 Mach-O 文件合并而成。它通过 Fat Header 来记录不同架构在文件中的偏移量，Fat Header 占一页(64位16kb，32位4kb)的空间。按分页来存储这些 segement 和 header 会浪费空间，但这有利于虚拟内存的实现。"><meta property="og:type" content="blog"><meta property="og:title" content="iOS应用 main 执行前发生的事情"><meta property="og:url" content="http://example.com/2019/07/19/iOS%E5%BA%94%E7%94%A8-main-%E6%89%A7%E8%A1%8C%E5%89%8D%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/"><meta property="og:site_name" content="千行的博客"><meta property="og:description" content="这篇是对 iOS 应用启动时，main 函数执行前发生的事的一点总结，限于水平，如有错误请指正~ FAT 二进制FAT 二进制文件，将多种架构的 Mach-O 文件合并而成。它通过 Fat Header 来记录不同架构在文件中的偏移量，Fat Header 占一页(64位16kb，32位4kb)的空间。按分页来存储这些 segement 和 header 会浪费空间，但这有利于虚拟内存的实现。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2019/07/16/5d2d7fbfbad2d16193.png"><meta property="og:image" content="https://i.loli.net/2019/07/16/5d2d33a11b54759536.png"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1929756-afb6f9e44e85a834.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1929756-f08a65e6164284a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1929756-632845e24fd90afd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="https://i.loli.net/2019/07/18/5d3054bb2f41b84030.jpg"><meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Butterfly-ImageLoader.png"><meta property="og:image" content="https://i.loli.net/2019/07/17/5d2ec84e3414c16255.png"><meta property="og:image" content="https://i.loli.net/2019/07/18/5d2fdcba273bf19458.jpg"><meta property="og:image" content="https://i.loli.net/2019/07/18/5d2fdcf3c16be55910.jpg"><meta property="og:image" content="https://i.loli.net/2019/07/18/5d300eef8d17d46008.png"><meta property="article:published_time" content="2019-07-19T06:02:28.000Z"><meta property="article:modified_time" content="2022-10-21T02:13:53.000Z"><meta property="article:author" content="千行"><meta property="article:tag" content="runtime"><meta property="article:tag" content="mach-o"><meta property="article:tag" content="dyld"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://i.loli.net/2019/07/16/5d2d7fbfbad2d16193.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2019/07/19/iOS%E5%BA%94%E7%94%A8-main-%E6%89%A7%E8%A1%8C%E5%89%8D%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/"},"headline":"iOS应用 main 执行前发生的事情","image":["https://i.loli.net/2019/07/16/5d2d7fbfbad2d16193.png","https://i.loli.net/2019/07/16/5d2d33a11b54759536.png","https://i.loli.net/2019/07/18/5d3054bb2f41b84030.jpg","https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Butterfly-ImageLoader.png","https://i.loli.net/2019/07/17/5d2ec84e3414c16255.png","https://i.loli.net/2019/07/18/5d2fdcba273bf19458.jpg","https://i.loli.net/2019/07/18/5d2fdcf3c16be55910.jpg","https://i.loli.net/2019/07/18/5d300eef8d17d46008.png"],"datePublished":"2019-07-19T06:02:28.000Z","dateModified":"2022-10-21T02:13:53.000Z","author":{"@type":"Person","name":"千行"},"publisher":{"@type":"Organization","name":"千行的博客","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.svg"}},"description":"这篇是对 iOS 应用启动时，main 函数执行前发生的事的一点总结，限于水平，如有错误请指正~ FAT 二进制FAT 二进制文件，将多种架构的 Mach-O 文件合并而成。它通过 Fat Header 来记录不同架构在文件中的偏移量，Fat Header 占一页(64位16kb，32位4kb)的空间。按分页来存储这些 segement 和 header 会浪费空间，但这有利于虚拟内存的实现。"}</script><link rel="canonical" href="http://example.com/2019/07/19/iOS%E5%BA%94%E7%94%A8-main-%E6%89%A7%E8%A1%8C%E5%89%8D%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-0VD5EHM46E" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-0VD5EHM46E');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="千行的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-19T06:02:28.000Z" title="7/19/2019, 2:02:28 PM">2019-07-19</time>发表</span><span class="level-item"><time dateTime="2022-10-21T02:13:53.000Z" title="10/21/2022, 10:13:53 AM">2022-10-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%E6%9D%82/">iOS杂</a></span><span class="level-item">32 分钟读完 (大约4753个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">iOS应用 main 执行前发生的事情</h1><div class="content"><p>这篇是对 iOS 应用启动时，main 函数执行前发生的事的一点总结，限于水平，如有错误请指正~</p>
<h3 id="FAT-二进制"><a href="#FAT-二进制" class="headerlink" title="FAT 二进制"></a>FAT 二进制</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fat_binary">FAT 二进制文件</a>，将多种架构的 Mach-O 文件合并而成。它通过 Fat Header 来记录不同架构在文件中的偏移量，Fat Header 占一页(64位16kb，32位4kb)的空间。<br>按分页来存储这些 segement 和 header 会浪费空间，但这有利于虚拟内存的实现。</p>
<p><img src="https://i.loli.net/2019/07/16/5d2d7fbfbad2d16193.png"></p>
<h3 id="Mach-O-文件"><a href="#Mach-O-文件" class="headerlink" title="Mach-O 文件"></a>Mach-O 文件</h3><p><code>Mach-O</code>为 Mach Object 文件格式的缩写，它是一种用于可执行文件，目标代码，动态库，内核转储的文件格式。<br>在 Mac OS X 系统中使用 Mach-O 作为其可执行文件类型。<br>它的组成结构如下图所示：</p>
<p><img src="https://i.loli.net/2019/07/16/5d2d33a11b54759536.png" alt="Mach-O 文件结构"></p>
<p>每个 Mach-O 文件包括一个 Mach-O Header，然后是一系列的载入命令 load commands，再是一个或多个段(segment)，每个段包括0到255个节(section)。Mach-O使用REL再定位格式控制对符号的引用。Mach-O在两级命名空间中将每个符号编码成“对象-符号名”对（所以需要保持 selector 的唯一），在查找符号时则采用线性搜索法。</p>
<p>Mach-O包含了几个 segment，每个 segment 又包含几个 section。segment的名字都是大写的，例如__DATA;section的名字都是小写的, 例如 __text。在 Mach-O 的类型不为<code>MH_OBJECT</code>时，空间大小为页的整数倍。页的大小跟硬件有关，在 arm64 架构一页是16kb，其余为4kb。<br>section 虽然没有整数倍页大小的限制，但是 section 之间不会有重叠。</p>
<h3 id="Mach-O-Header"><a href="#Mach-O-Header" class="headerlink" title="Mach-O Header"></a>Mach-O Header</h3><p>推荐使用<code>MachOView</code>这个软件查看 Mach-O 的文件结构。注意需要<code>手动关闭 processing</code>，不然会闪退。下面是用 MachOView 查看自己的应用结构：<br><img src="https://upload-images.jianshu.io/upload_images/1929756-afb6f9e44e85a834.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="使用MachOView查看文件结构"></p>
<p>东西有点多就没有截取全部。我们查看一下<code>Mach-O Header</code>部分<br><img src="https://upload-images.jianshu.io/upload_images/1929756-f08a65e6164284a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Header结构"></p>
<p>下面是64位架构下<code>header</code>的数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="type">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="type">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="type">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	<span class="type">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1929756-632845e24fd90afd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<p>Mach-O 全部的 filetype 和 flags 可以在<code>loader.h</code>中找到。</p>
<hr>
<p>除了<code>MH_OBJECT</code>以外的所有类型，段(Segment)的空间大小均为页的整数倍。页的大小跟硬件有关系，在 arm64 架构下一页为16kb，其它为4kb。</p>
<h3 id="Load-commands"><a href="#Load-commands" class="headerlink" title="Load commands"></a>Load commands</h3><p><code>Load commands</code>紧跟在头部之后, 当加载过 header 之后，会通过解析<code>Load commands</code>来加载剩下的数据，确定其内存的分布。<br>下面是 load commands 的结构定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct load_command &#123;</span><br><span class="line">	uint32_t cmd;		/* 载入命令类型 */</span><br><span class="line">	uint32_t cmdsize;	/* total size of command in bytes */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所有<code>load commands</code>的大小即为 Header-&gt;sizeofcmds, 共有 Header-&gt;ncmds 条<code>load command</code>。<br>load command 以<code>LC</code>开头，不同的加载命令有不同的专有的结构体，cmd 和 cmdsize 是都有的，分别为命令类型（即命令名称），这条命令的长度。这些加载命令告诉系统应该如何处理后面的二进制数据，对系统内核加载器和动态链接器起指导作用。如果当前 LC_SEGMENT 包含 section，那么 section 的结构体紧跟在 LC_SEGMENT 的结构体之后，所占字节数由 SEGMENT 的 cmdsize 字段给出。</p>
<table>
<thead>
<tr>
<th>cmd(命令名称)</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LC_SEGMENT_64</td>
<td>将对应的段中的数据加载并映射到进程的内存空间去</td>
</tr>
<tr>
<td>LC_SYMTAB</td>
<td>符号表信息</td>
</tr>
<tr>
<td>LC_DYSYMTAB</td>
<td>动态符号表信息</td>
</tr>
<tr>
<td>LC_LOAD_DYLINKER</td>
<td>启动动态加载连接器&#x2F;usr&#x2F;lib&#x2F;dyld程序</td>
</tr>
<tr>
<td>LC_UUID</td>
<td>唯一的 UUID，标示该二进制文件，128bit</td>
</tr>
<tr>
<td>LC_VERSION_MIN_IPHONEOS&#x2F;MACOSX</td>
<td>要求的最低系统版本（Xcode中的Deployment Target）</td>
</tr>
<tr>
<td>LC_MAIN</td>
<td>设置程序主线程的入口地址和栈大小</td>
</tr>
<tr>
<td>LC_ENCRYPTION_INFO</td>
<td>加密信息</td>
</tr>
<tr>
<td>LC_LOAD_DYLIB</td>
<td>加载的动态库，包括动态库地址、名称、版本号等</td>
</tr>
<tr>
<td>LC_FUNCTION_STARTS</td>
<td>函数地址起始表</td>
</tr>
<tr>
<td>LC_CODE_SIGNATURE</td>
<td>代码签名信息</td>
</tr>
</tbody></table>
<p>注意：不同类型的 segment 会使用不同的函数来加载</p>
<h3 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h3><p>Mach-O 文件中由许多个段（Segment），每个段都有不同的功能，每个段包含了许多个小的Section。<code>LC_SEGMENT</code>意味着这部分文件需要映射到进程的地址空间去，几乎所有 Mach-O 都包含这三个段：</p>
<ol>
<li>__TEXT：包含了执行代码和其它只读数据(如C 字符串)。权限：只读(VM_PROT_READ)，可执行(VM_PROT_EXECUTE)</li>
<li>__DATA：程序数据，包含全局变量，静态变量等。权限：可读写(VM_PROT_WRITE&#x2F;READ) 可执行(VM_PROT_EXECUTE)</li>
<li>__LINKEDIT：包含了加载程序的”元数据”，比如函数的名称和地址。权限：只读(VM_PROT_READ)</li>
</ol>
<p>除了上面三个，还有一个常见的 segment：</p>
<ul>
<li>__PAGEZERO：空指针陷阱段，映射到虚拟内存空间的第一页，用于捕捉对 NULL 指针的引用</li>
</ul>
<p><code>LC_SEGMENT_64</code> 的结构定义为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> &#123;</span> <span class="comment">/* for 64-bit architectures */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SEGMENT_64 */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes sizeof section_64 structs */</span></span><br><span class="line">	<span class="type">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment name */</span></span><br><span class="line">	<span class="type">uint64_t</span>	vmaddr;		<span class="comment">/* memory address of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	vmsize;		<span class="comment">/* memory size of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	fileoff;	<span class="comment">/* file offset of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	filesize;	<span class="comment">/* amount to map from the file */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	maxprot;	<span class="comment">/* maximum VM protection */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	initprot;	<span class="comment">/* initial VM protection */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nsects;		<span class="comment">/* number of sections in segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到这里大部分的成员变量都是帮助内核将 segment 映射到虚拟内存的。<code>nsects</code>即表明该段中包含多少个 section，section是具体数据存放的地方。<code>cmdsize</code>表示当前 segment 结构体以及它所包含的所有 section 结构体的总大小。</p>
<p>文件映射的起始位置由<code>fileoff</code>给出，映射到地址空间的<code>vmaddr</code>处。</p>
<h3 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h3><p>section 的名字均为小写。section 是具体数据存放的地方，它的结构体跟随在 LC_SEGMENT 结构体之后。在64位环境中它的结构定义为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct section_64 &#123; /* for 64-bit architectures */</span><br><span class="line">	char		sectname[16];	/* name of this section */</span><br><span class="line">	char		segname[16];	/* segment this section goes in */</span><br><span class="line">	uint64_t	addr;		/* memory address of this section */</span><br><span class="line">	uint64_t	size;		/* size in bytes of this section */</span><br><span class="line">	uint32_t	offset;		/* file offset of this section */</span><br><span class="line">	uint32_t	align;		/* section alignment (power of 2) */</span><br><span class="line">	uint32_t	reloff;		/* file offset of relocation entries */</span><br><span class="line">	uint32_t	nreloc;		/* number of relocation entries */</span><br><span class="line">	uint32_t	flags;		/* flags (section type and attributes)*/</span><br><span class="line">	uint32_t	reserved1;	/* reserved (for offset or index) */</span><br><span class="line">	uint32_t	reserved2;	/* reserved (for count or sizeof) */</span><br><span class="line">	uint32_t	reserved3;	/* reserved */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>flasg</code>字段储存了两个属性的值：type 和 attributes。type 只能有一个值，而 attributes 的值可以有多个。如果 segment 中任何一个 section 拥有属性 S_ATTR_DEBUG，那么该段所有的 section 都会拥有这个属性。属性详情可以参考<code>loader.h</code></p>
<table>
<thead>
<tr>
<th>section name</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>__text</td>
<td>主程序代码</td>
</tr>
<tr>
<td>__stub_helper</td>
<td>用于动态链接的存根</td>
</tr>
<tr>
<td>__symbolstub1</td>
<td>用于动态链接的存根</td>
</tr>
<tr>
<td>__objc_methname</td>
<td>Objective-C 的方法名</td>
</tr>
<tr>
<td>__objc_classname</td>
<td>Objective-C 的类名</td>
</tr>
<tr>
<td>__cstring</td>
<td>硬编码的字符串</td>
</tr>
<tr>
<td>__lazy_symbol</td>
<td>懒加载，延迟加载节，通过 dyld_stub_binder 辅助链接</td>
</tr>
<tr>
<td>_got</td>
<td>存储引用符号的实际地址，类似于动态符号表</td>
</tr>
<tr>
<td>__nl_symbol_ptr</td>
<td>非延迟加载节</td>
</tr>
<tr>
<td>__mod_init_func</td>
<td>初始化的全局函数地址，在 main 之前被调用</td>
</tr>
<tr>
<td>__mod_term_func</td>
<td>结束函数地址</td>
</tr>
<tr>
<td>__cfstring</td>
<td>Core Foundation 用到的字符串（OC字符串）</td>
</tr>
<tr>
<td>__objc_clsslist</td>
<td>Objective-C 的类列表</td>
</tr>
<tr>
<td>__objc_nlclslist</td>
<td>Objective-C 的 +load 函数列表，比 __mod_init_func 更早执行</td>
</tr>
<tr>
<td>__objc_const</td>
<td>Objective-C 的常量</td>
</tr>
<tr>
<td>__data</td>
<td>初始化的可变的变量</td>
</tr>
<tr>
<td>__bss</td>
<td>未初始化的静态变量</td>
</tr>
</tbody></table>
<h3 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><p>在 segment 的结构体中，我们可以看到<code>vmaddr</code>和<code>vmsize</code>两个成员变量，它们分别代表 segment 在虚拟内存中的地址以及大小。</p>
<p><code>虚拟内存</code>就是一层间接寻址（indirection）。软件工程中有句格言就是任何问题都能通过添加一个间接层来解决。虚拟内存解决的是管理所有进程使用物理 RAM 的问题。通过添加间接层来让每个进程使用逻辑地址空间，它可以映射到 RAM 上的某个物理页上。这种映射不是一对一的，逻辑地址可能映射不到 RAM 上，也可能有多个逻辑地址映射到同一个物理 RAM 上。针对第一种情况，当进程要存储逻辑地址内容时会触发 page fault；第二种情况就是多进程共享内存。</p>
<p>对于文件可以不用一次性读入整个文件，可以使用<code>分页映射（mmap()）</code>的方式读取。也就是把文件某个片段映射到进程逻辑内存的某个页上。当某个想要读取的页没有在内存中，就会触发 page fault，内核只会读入那一页，实现文件的懒加载。</p>
<p>也就是说 Mach-O 文件中的<code>__TEXT</code>段可以映射到多个进程，并可以懒加载，且进程之间共享内存。<code>__DATA</code>段是可读写的。这里使用到了<code>Copy-On-Write</code>技术，简称 COW。也就是多个进程共享一页内存空间时，一旦有进程要做写操作，它会先将这页内存内容复制一份出来，然后重新映射逻辑地址到新的 RAM 页上。也就是这个进程自己拥有了那页内存的拷贝。这就涉及到了 clean&#x2F;dirty page 的概念。dirty page 含有进程自己的信息，而 clean page 可以被内核重新生成（重新读磁盘）。所以 dirty page 的代价大于 clean page。</p>
<p>在多个进程加载 Mach-O 文件时<code>__TEXT</code>和<code>__LINKEDIT</code>因为只读，都是可以共享内存的。而<code>__DATA</code>因为可读写，就会产生 dirty page。当 dyld 执行结束后，<code>__LINKEDIT</code>就没用了，对应的内存页会被回收。</p>
<h3 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h3><p><img src="https://i.loli.net/2019/07/18/5d3054bb2f41b84030.jpg" alt="dyld"></p>
<p><em>dyld</em>（the dynamic link editor），Apple 的动态链接器。在内核完成映射进程的工作后会启动<code>dyld</code>，负责加载应用依赖的所有动态链接库，准备好运行所需的一切。<br>在 App 启动的时候，首先会加载 App 的 mach-o 文件，从 load commands 中得到 dyld 的路径，并且运行。随后 dyld 做的事情顺序概括如下：</p>
<ol>
<li>初始化运行环境</li>
<li>加载主程序执行文件 生成 image, 将image添加到一个全局容器中</li>
<li>加载共享缓存</li>
<li>根据依赖链递归加载动态链接库 dylib，如果在缓存中有加载好的 image 则直接拿出来，否则生成一个新的 image，将image添加到一个全局容器中</li>
<li>link 主执行文件</li>
<li>link dylib<ul>
<li>根据依赖链递归修正指针 Rebase</li>
<li>根据依赖链递归符号绑定 Bind</li>
</ul>
</li>
<li>初始化 dylib（runtime 的初始化就在这个时候）</li>
</ol>
<p>在加载完所有的 dylib 之后，它们处于互相独立的状态，所以还需要将它们绑定起来。代码签名让我们不能修改指令，所以不能直接让一个 dylib 调用另一个 dylib，这时需要很多间接层。<br>这个时候需要 dyld 来修正指针(rebasing)和绑定符号(binding)。</p>
<p>详细可以查看 dyld 的<a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/dyld/">源码</a>中的<code>_main</code>函数。<br>下面会分析上述的其中几个步骤。</p>
<h3 id="ImageLoader"><a href="#ImageLoader" class="headerlink" title="ImageLoader"></a>ImageLoader</h3><p> <code>ImageLoader</code>是一个将 mach-o 文件里面二进制数据(编译过的代码、符号等)加载到内存的基类，它负责将 mach-o 中的二进制数据映射到内存，它的实例就是我们熟悉的 image。<br> 每一个 mach-o 文件都会有一个对应的 image，实例的类型根据 mach-o 格式的不同也会不同。</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Butterfly-ImageLoader.png"></p>
<ul>
<li>ImageLoaderMachOClassic: 用于加载<code>__LINKEDIT</code>段为传统格式的 mach-o 文件</li>
<li>ImageLoaderMachOCompressed: 用于加载<code>__LINKEDIT</code>段为压缩格式的 mach-o 文件</li>
</ul>
<p>因为<code>dylib</code>之间有依赖关系，所以系统会沿着依赖链递归加载 image。</p>
<h3 id="Rebasing"><a href="#Rebasing" class="headerlink" title="Rebasing"></a>Rebasing</h3><p><code>dylib</code>的二进制数据会随机的映射到内存的一个随机地址ASLR(Address space layout randomization,)中，这个随机的地址跟代码和数据指向的旧地址(preferred_address)会有一定的偏差，<code>dyld</code>需要修正这个偏差(slide)，做法就是将<code>dylib</code>内部的指针地址都加上这个偏移值，偏移值的计算方法如下：</p>
<p>slide &#x3D; actual_address - preferred_address</p>
<p>随后就是不断的将<code>__DATA</code>段中需要修正的指针加上这个偏移值。<br>注意：每次程序启动后的地址都会变化，所以指针的地址都需要重新修正。</p>
<p>在 mach-o 的一个载入命令<code>LC_DYLD_INFO_ONLY</code>可以查看到<code>rebase</code>, <code>bind</code>, <code>week_bind</code>,<code>lazy_bind</code>的偏移量和大小。</p>
<p><img src="https://i.loli.net/2019/07/17/5d2ec84e3414c16255.png"></p>
<h3 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h3><p><code>binding</code>处理那些指向<code>dylib</code>外部的指针，它们实际上被符号名称(symbol)绑定，也就是个字符串。比如我们 objc 代码中需要使用到 NSObject, 即符号_OBJC_CLASS_$_NSObject，但是这个符号不存在当前的 image 中，而是在系统库 Foundation.framework中，因此就需要binding这个操作将对应关系绑定到一起。</p>
<h3 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h3><p><code>lazyBinding</code>就是在加载动态库的时候不会立即 binding, 当时当第一次调用这个方法的时候再实施 binding。 做到的方法也很简单： 通过<code>dyld_stub_binder</code>这个符号来做。lazy binding 的方法第一次会调用到 dyld_stub_binder, 然后 dyld_stub_binder负责找到真实的方法，并且将地址bind到桩上，下一次就不用再bind了。<br>多数符号都是 lazy binding 的</p>
<h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><p>每一个<code>dylib</code>都有自己的初始化方法，当相应的 image 被加载到内存后，就会调用初始化方法。当然这不是调用名为<code>initialize</code>方法，而是C++静态对象初始化构造器，<code>__attribute__((constructor))</code>标记的方法以及<code>Initializer</code>方法。你可以在程序中设置环境变量<code>DYLD_PRINT_INITIALIZERS</code>来打印<code>dylib</code>的初始化方法。</p>
<p><img src="https://i.loli.net/2019/07/18/5d2fdcba273bf19458.jpg"></p>
<p><img src="https://i.loli.net/2019/07/18/5d2fdcf3c16be55910.jpg" alt="打印信息"></p>
<p>我们可以看到程序首先调用了<code>libSystem</code>这个dylib的初始化方法。<code>libSystem</code>是很多系统的lib的集合，包括 libdispatch(GCD), libsystem_c(c语言库), libsystem_blocks(block)。<br>在<code>libSystem</code>的源码<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/Libsystem/Libsystem-169.3/init.c">init.c</a>中我们可以看到，它的初始化方法<code>libSystem_initializer</code>会调用<code>libdispatch_init();</code>, 然后逐步调用到<code>_objc_init</code>，也就是 objc 和 runtime 的入口。<br>添加一个符号断点<code>_objc_init</code>，下面是方法调用栈：</p>
<p><img src="https://i.loli.net/2019/07/18/5d300eef8d17d46008.png" alt="断点调试"></p>
<p>注意：runtime 和 objc 属于<code>libobjc</code></p>
<hr>
<p>下面是<code>_objc_init</code>的实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void _objc_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    // 省略...</span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的<code>map_images</code>不是将 image 添加到内存中的意思，在这个方法被调用的时候，已经完成了 image 的映射以及指针修正，绑定符号的工作了。<br>这个函数实际上是将 image 中 OBJC 相关的信息进行初始化，具体实现可以查看<code>_read_image</code>的源码，因为代码太多所以这里就不贴出来了，下面是具体做的事情：</p>
<ul>
<li>会将所有的 Class 存放在一张映射类名与 Class 的全局表中<code>gdb_objc_realized_classes</code></li>
<li>随后调用<code>readClass</code>函数将 每一个 Class 添加到<code>gdb_objc_realized_classes</code>表中。</li>
<li>确定 selector 是唯一的</li>
<li>read protocols: 读取protocol</li>
<li>realizeClasses：这一步的意义就是动态链接好class, 让class处于可用状态，主要操作如下：<ul>
<li>检查ro是否已经替换为rw,没有就替换一下。</li>
<li>检查类的父类和metaClass是否已经realize,没有就先把它们先realize</li>
<li>重新layout ivar. 因为只有加载好了所有父类，才能确定ivar layout</li>
<li>把一些flags从ro拷贝到rw</li>
<li>链接class的 nextSiblingClass 链表</li>
<li>attach categories: 合并categories的method list、 properties、protocols到 class_rw_t 里面</li>
</ul>
</li>
<li>read categories：读取类目</li>
</ul>
<p>在<code>map_images</code>结束会调用<code>load_images</code>函数。这一步做的事情比较少，就是调用我们熟悉的<code>+(load)</code>函数。父类会先调用，除了 Class，每个类目的<code>+(load)</code>方法也会被调用一次，但顺序就不一定了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这里对 main 函数之前的操作做一个小总结吧：</p>
<ol>
<li>将 App 的 mach-o header 读取到内存中</li>
<li>根据 load commands 获取 dyld 的路径，运行 dyld</li>
<li>初始化运行环境，加载 dylib，如果缓存中存在则从缓存中拿出加载过的 image，否则新建一个 image，加载到内存中</li>
<li>修正指针(rebase)，绑定符号(bind)</li>
<li>初始化 dylib，运行 runtime</li>
<li>runtime 将 image 中有关 OBJC 的数据进行初始化</li>
<li>调用 +(load) 方法</li>
<li>dyld 调用 main 函数</li>
</ol>
<p>花了一周的时间用来研究这部分的内容，终于填完坑了<del>很舒服<br>最大的感受就是学习完后，看 clang 编译后的 C++ 代码能看懂的更多了。比如添加完一个类目之后，会将这个这个类目添加到__DATA的section <code>__objc_catlist</code>中，以前不知道啥意思现在就明白了。也明白 xcode 的许多设置是用来干嘛的，总之好处多多</del><br>学习也是一个递归的过程，加油跳出这个递归吧！</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p><a target="_blank" rel="noopener" href="http://blog.sunnyxx.com/2014/08/30/objc-pre-main/">iOS 程序 main 函数之前发生了什么</a><br><a target="_blank" rel="noopener" href="http://yulingtianxia.com/blog/2016/10/30/Optimizing-App-Startup-Time/#dyld-%E5%8A%A0%E8%BD%BD-dylib-%E6%96%87%E4%BB%B6">优化 App 的启动时间</a><br><a target="_blank" rel="noopener" href="https://turingh.github.io/2016/03/16/dyld%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90load/#0x03_%E5%B0%8F%E7%BB%93">dyld源码分析-动态加载load</a><br><a target="_blank" rel="noopener" href="https://blog.cnbluebox.com/blog/2017/06/20/dyldyu-objc/">dyld与ObjC</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>iOS应用 main 执行前发生的事情</p><p><a href="http://example.com/2019/07/19/iOS应用-main-执行前发生的事情/">http://example.com/2019/07/19/iOS应用-main-执行前发生的事情/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>千行</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-07-19</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-10-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/runtime/">runtime</a><a class="link-muted mr-2" rel="tag" href="/tags/mach-o/">mach-o</a><a class="link-muted mr-2" rel="tag" href="/tags/dyld/">dyld</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/07/30/YYModel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">YYModel实现原理</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/07/10/Objective-C%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83/"><span class="level-item">Objective-C类和对象的内存分布</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'http://example.com/2019/07/19/iOS%E5%BA%94%E7%94%A8-main-%E6%89%A7%E8%A1%8C%E5%89%8D%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/';
            this.page.identifier = '2019/07/19/iOS应用-main-执行前发生的事情/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'qianxingdeblog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="千行"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">千行</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>杭州, 浙江</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">21</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/bug/"><span class="level-start"><span class="level-item">bug</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/cocoapods/"><span class="level-start"><span class="level-item">cocoapods</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/iOS%E6%9D%82/"><span class="level-start"><span class="level-item">iOS杂</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%90%AD%E5%BB%BA/"><span class="level-start"><span class="level-item">搭建</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/EventKit/"><span class="tag">EventKit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GCD/"><span class="tag">GCD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NSError/"><span class="tag">NSError</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Runloop/"><span class="tag">Runloop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tagged-Pointer/"><span class="tag">Tagged Pointer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/YTKNetwork/"><span class="tag">YTKNetwork</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/YYModel/"><span class="tag">YYModel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/block/"><span class="tag">block</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dyld/"><span class="tag">dyld</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mach-o/"><span class="tag">mach-o</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/runtime/"><span class="tag">runtime</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/weak/"><span class="tag">weak</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/"><span class="tag">关联对象</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83/"><span class="tag">内存分布</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tag">多线程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%A1%E6%A0%B8/"><span class="tag">审核</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/"><span class="tag">引用计数</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82/"><span class="tag">杂</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81/"><span class="tag">源码</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81/"><span class="tag">锁</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="千行的博客" height="28"></a><p class="is-size-7"><span>&copy; 2022 千行</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>